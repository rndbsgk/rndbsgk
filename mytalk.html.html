<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTalk P2P - Account System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
    <style>
        /* 스타일: 깔끔한 디자인 유지 */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9ebee; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background-color: #ffffff; border-radius: 15px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); width: 100%; max-width: 600px; height: 90vh; max-height: 950px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #d0d0d0; }
        .screen { flex-grow: 1; padding: 0; display: none; flex-direction: column; overflow: hidden; } 
        
        /* 로그인/회원가입 화면 스타일 */
        #loginScreen, #signupScreen { display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px; background-color: #ffffff; gap: 15px; }
        
        /* 로딩 화면 */
        #loadingScreen { display: none; justify-content: center; align-items: center; flex-direction: column; background-color: #ffffff; color: #333; }
        #loadingScreen .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1877f2; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 입력 폼 스타일 */
        .auth-form { width: 100%; max-width: 300px; display: flex; flex-direction: column; gap: 12px; }
        .auth-form input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; transition: border-color 0.2s; }
        .auth-form input:focus { border-color: #1877f2; outline: none; }
        
        /* 버튼 스타일 */
        .main-button { width: 100%; padding: 15px; background-color: #1877f2; color: #ffffff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; font-size: 1em; }
        .main-button:hover { background-color: #1a6edb; }
        .secondary-button { background: none; color: #1877f2; border: none; cursor: pointer; font-size: 0.9em; padding: 10px 0; }
        .secondary-button:hover { text-decoration: underline; }

        /* 체크박스 스타일 */
        .login-options { display: flex; align-items: center; font-size: 0.9em; color: #666; width: 100%; }
        .login-options label { display: flex; align-items: center; cursor: pointer; gap: 5px; }

        /* 메인 앱 UI (헤더, 푸터 등) */
        .header { background-color: #ffffff; padding: 15px; font-weight: bold; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header button { background: none; border: none; font-size: 1em; color: #1877f2; cursor: pointer;} 
        .footer-nav { background-color: #ffffff; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #e0e0e0; flex-shrink: 0; }
        .footer-nav button { background: none; border: none; color: #888; padding: 10px; cursor: pointer; font-size: 0.9em; }
        .footer-nav button.active { color: #1877f2; font-weight: bold; }
        .content-list { flex-grow: 1; overflow-y: auto; background-color: #f8f8f8; }
        
        /* 프로필 및 친구 목록 */
        .my-profile { padding: 15px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; background-color: #ffffff; flex-shrink: 0; }
        .my-profile img { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; border: 2px solid #1877f2; }
        .profile-info h3 { margin: 0; color: #333; }
        .profile-info p { margin: 3px 0 0; color: #666; font-size: 0.9em; }
        .search-area { padding: 10px 15px; display: flex; gap: 10px; background-color: #f0f2f5; border-bottom: 1px solid #e0e0e0; flex-shrink: 0;}
        .search-area input { flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .search-area button { padding: 8px 12px; background-color: #1877f2; color: #ffffff; font-weight: bold; border: none; border-radius: 5px; cursor: pointer;}
        
        .list-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #e0e0e0; background-color: #ffffff; cursor: pointer; }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item img { width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; }
        .item-info h4 { margin: 0; color: #333; }
        .item-info p { margin: 2px 0 0; color: #666; font-size: 0.85em; }

        /* 채팅방 */
        #chatDetailScreen { display: none; flex-direction: column; background-color: #f0f2f5; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message-bubble { max-width: 70%; padding: 10px; border-radius: 15px; position: relative; border: 1px solid #ccc; word-break: break-word; }
        .message-bubble.sent { background-color: #dcf8c6; align-self: flex-end; border-color: #b2d899; } 
        .message-bubble.received { background-color: #ffffff; align-self: flex-start; border-color: #ccc; }
        .message-bubble .time { font-size: 0.7em; color: #888; text-align: right; margin-top: 5px; }
        .chat-input-area { display: flex; padding: 10px; background-color: #ffffff; border-top: 1px solid #e0e0e0; align-items: center; flex-shrink: 0;}
        .chat-input-area input { flex-grow: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; margin-right: 10px; }
        .chat-input-area button { padding: 8px 15px; background-color: #1877f2; color: #ffffff; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* 모달 */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 15px; width: 80%; max-width: 300px; display: flex; flex-direction: column; gap: 15px; }
        .modal-content input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .modal-content h3 { margin-top: 0; color: #1877f2; text-align: center; }
        #fileModal .file-options { display: flex; flex-direction: column; gap: 10px; }
        #fileModal .file-options button { padding: 12px; border: 1px solid #1877f2; background-color: #ffffff; color: #1877f2; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #fileModal .file-options button:hover { background-color: #f0f2f5; }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="loginScreen" class="screen">
            <h2 style="color: #1877f2;">EcoTalk 로그인</h2>
            <div class="auth-form">
                <input type="text" id="loginId" placeholder="아이디">
                <input type="password" id="loginPw" placeholder="비밀번호">
                <div class="login-options">
                    <label><input type="checkbox" id="keepLoggedIn"> 로그인 상태 유지</label>
                </div>
                <button class="main-button" onclick="handleLogin()">로그인</button>
            </div>
            <button class="secondary-button" onclick="showScreen('signupScreen')">계정 새로 만들기</button>
        </div>

        <div id="signupScreen" class="screen">
            <h2 style="color: #1877f2;">계정 만들기</h2>
            <div class="auth-form">
                <input type="text" id="signupId" placeholder="사용할 아이디 (영문/숫자)">
                <input type="password" id="signupPw" placeholder="비밀번호 설정">
                <input type="password" id="signupPwConfirm" placeholder="비밀번호 확인">
                <button class="main-button" onclick="handleSignup()">계정 만들기</button>
            </div>
            <button class="secondary-button" onclick="showScreen('loginScreen')">돌아가기</button>
        </div>

        <div id="loadingScreen" class="screen">
            <div class="spinner"></div>
            <p>네트워크 연결 중...</p>
        </div>

        <div id="friendsScreen" class="screen">
            <div class="header">
                <span>Friends</span>
                <div class="header-buttons">
                    <button onclick="openProfileModal()">프로필</button>
                    <button onclick="handleLogout()">로그아웃</button>
                </div>
            </div>
            <div class="my-profile">
                <img id="myProfilePic" src="https://ui-avatars.com/api/?name=Me&background=1877f2&color=fff">
                <div class="profile-info">
                    <h3 id="myProfileName">나</h3>
                    <p id="myProfileID">ID: ...</p>
                    <p id="myProfileStatus">연결됨</p>
                </div>
            </div>
            <div class="search-area">
                <input type="text" id="friendIdSearch" placeholder="친구 ID 입력">
                <button onclick="connectToPeer()">+ 추가</button>
            </div>
            <div id="friendListContent" class="content-list">
                <p style="text-align:center; padding:20px; color:#888;">연결된 친구가 없습니다.</p>
            </div>
            <div class="footer-nav">
                <button class="active" onclick="showScreen('friendsScreen', this)">Friends</button>
                <button onclick="showScreen('chatListScreen', this)">Chats</button>
            </div>
        </div>

        <div id="chatListScreen" class="screen">
            <div class="header">Chats</div>
            <div id="chatListContent" class="content-list"></div>
            <div class="footer-nav">
                <button onclick="showScreen('friendsScreen', this)">Friends</button>
                <button class="active" onclick="showScreen('chatListScreen', this)">Chats</button>
            </div>
        </div>

        <div id="chatDetailScreen" class="screen">
            <div class="header">
                <button onclick="showScreen('friendsScreen')">&lt;</button>
                <span id="chatPartnerName"></span>
                <span style="width:30px"></span>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="메시지 입력..." onkeydown="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()">전송</button>
            </div>
        </div>

        <div id="profileModal" class="modal">
            <div class="modal-content">
                <h3>프로필 수정</h3>
                <input type="text" id="editName" placeholder="이름">
                <input type="text" id="editStatus" placeholder="상태 메시지">
                <button class="secondary-button main-button" style="background-color: #4CAF50; color: white;" onclick="openFileModal()">프로필 사진 변경</button>
                <button class="main-button" onclick="saveProfile()">저장</button>
                <button class="secondary-button" onclick="document.getElementById('profileModal').style.display='none'">취소</button>
            </div>
        </div>

        <div id="fileModal" class="modal">
            <div class="modal-content">
                <h3>사진 선택</h3>
                <div class="file-options">
                    <input type="text" id="selectedFileUrl" placeholder="URL 또는 #색상코드">
                    <button onclick="selectProfilePicture('DEFAULT')">기본 이미지(이니셜)</button>
                    <button onclick="confirmProfilePicture()">완료</button>
                </div>
                <button style="background-color: #ccc; color: #333; border: none; border-radius: 8px; padding: 12px; margin-top: 10px;" onclick="closeFileModal()">취소</button>
            </div>
        </div>

    </div>

    <script>
        // --- 저장소 키 ---
        const STORAGE_KEY = 'ecotalk_users';
        const LOGIN_KEY = 'ecotalk_login_session';

        // --- 전역 변수 ---
        let peer = null;
        let myId = '';
        let myName = '';
        let myStatus = '';
        let myPic = '';
        
        let connectedPeers = {}; // 연결된 친구들
        let activeChatId = null;

        // --- 1. 계정 관리 (Signup/Login) ---

        function getUsers() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        }

        function saveUser(id, pw) {
            const users = getUsers();
            if (users[id]) return false; // 이미 존재함
            // UI Avatars로 이니셜 이미지 생성
            const initialPic = `https://ui-avatars.com/api/?name=${id}&background=random&color=fff`;
            users[id] = { password: pw, name: id, status: '안녕하세요!', pic: initialPic };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
            return true;
        }

        function handleSignup() {
            const id = document.getElementById('signupId').value.trim().toUpperCase(); // ID 대문자 통일
            const pw = document.getElementById('signupPw').value;
            const pwConfirm = document.getElementById('signupPwConfirm').value;

            if (!id || !pw) return alert('ID와 비밀번호를 입력하세요.');
            if (pw !== pwConfirm) return alert('비밀번호가 일치하지 않습니다.');
            
            if (saveUser(id, pw)) {
                alert('계정이 생성되었습니다! 로그인해주세요.');
                showScreen('loginScreen');
            } else {
                alert('이미 있는 계정입니다. 다른 ID를 사용해주세요.');
            }
        }

        function handleLogin() {
            const id = document.getElementById('loginId').value.trim().toUpperCase();
            const pw = document.getElementById('loginPw').value;
            const keep = document.getElementById('keepLoggedIn').checked;

            const users = getUsers();
            if (users[id] && users[id].password === pw) {
                // 로그인 성공
                if (keep) {
                    localStorage.setItem(LOGIN_KEY, id); // 자동 로그인 설정
                }
                startApp(id);
            } else {
                alert('아이디 또는 비밀번호가 맞지 않습니다.');
            }
        }

        function handleLogout() {
            if(confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem(LOGIN_KEY);
                if (peer) peer.destroy();
                location.reload(); // 완전히 새로고침
            }
        }

        // --- 2. 앱 시작 (P2P 연결) ---

        function startApp(id) {
            myId = id;
            const users = getUsers();
            const user = users[id];
            myName = user.name;
            myStatus = user.status;
            myPic = user.pic;

            // UI 업데이트
            document.getElementById('myProfileID').textContent = 'ID: ' + myId;
            document.getElementById('myProfileName').textContent = myName;
            document.getElementById('myProfileStatus').textContent = myStatus;
            document.getElementById('myProfilePic').src = myPic;

            showScreen('loadingScreen');

            // PeerJS 연결
            peer = new Peer(myId, { debug: 1 }); // ID를 PeerID로 사용

            peer.on('open', (id) => {
                showScreen('friendsScreen');
            });

            peer.on('connection', (conn) => {
                handleConnection(conn);
            });

            peer.on('error', (err) => {
                alert('네트워크 오류: ' + err.type);
                // ID 중복 등으로 실패할 수 있음 (다른 탭에서 같은 ID 로그인 시 등)
                if(err.type === 'unavailable-id') {
                    alert('이미 접속 중인 ID입니다.');
                    showScreen('loginScreen');
                }
            });
        }

        // --- 3. P2P 연결 및 데이터 처리 ---

        function connectToPeer() {
            const targetId = document.getElementById('friendIdSearch').value.trim().toUpperCase();
            if (!targetId) return alert('ID를 입력하세요.');
            if (targetId === myId) return alert('자신과는 대화할 수 없습니다.');
            if (connectedPeers[targetId]) return alert('이미 연결된 친구입니다.');

            // 연결 시도
            const conn = peer.connect(targetId);
            
            conn.on('open', () => {
                // 내 정보 전송 (악수)
                conn.send({ type: 'INFO', name: myName, pic: myPic, status: myStatus });
                handleConnection(conn);
                alert('연결되었습니다!');
                document.getElementById('friendIdSearch').value = '';
            });

            conn.on('error', (err) => {
                alert('친구를 찾을 수 없습니다. 상대방이 로그인 중인지 확인하세요.');
            });
            
            // 5초 후에도 연결 안되면 타임아웃 처리 (간이)
            setTimeout(() => {
                if(!conn.open && !connectedPeers[targetId]) {
                    // alert('응답이 없습니다.'); 
                }
            }, 5000);
        }

        function handleConnection(conn) {
            const peerId = conn.peer;
            
            // 초기 데이터 구조 생성
            if (!connectedPeers[peerId]) {
                connectedPeers[peerId] = {
                    conn: conn,
                    name: peerId, // 정보 받기 전엔 ID로 표시
                    pic: 'https://via.placeholder.com/45/ccc/fff?text=?',
                    status: '',
                    messages: []
                };
            }

            // 데이터 수신 이벤트 처리
            conn.on('data', (data) => {
                handleIncomingData(peerId, data);
            });

            conn.on('close', () => {
                alert(peerId + '님과의 연결이 끊어졌습니다.');
                delete connectedPeers[peerId];
                renderFriendList();
                if (activeChatId === peerId) showScreen('friendsScreen');
            });

            renderFriendList();
        }

        // 수신된 데이터 처리
        function handleIncomingData(peerId, data) {
            // 1. 상대방 프로필 정보 수신
            if (data.type === 'INFO') {
                connectedPeers[peerId].name = data.name;
                connectedPeers[peerId].pic = data.pic;
                connectedPeers[peerId].status = data.status;
                renderFriendList();
            } 
            // 2. 텍스트 메시지 수신
            else if (data.type === 'CHAT') {
                const msgObj = {
                    sender: peerId,
                    content: data.content,
                    time: data.time
                };
                connectedPeers[peerId].messages.push(msgObj);
                
                // 현재 채팅 중이라면 화면 갱신, 아니면 알림(여기선 목록 갱신)
                if (activeChatId === peerId) {
                    renderMessages(peerId);
                } else {
                    renderChatList();
                }
            }
        }

        // --- 3. 메시지 전송 ---
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !activeChatId) return;

            const now = new Date();
            const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;

            // 내 화면에 추가
            const myMsg = { sender: myId, content: text, time: timeStr };
            connectedPeers[activeChatId].messages.push(myMsg);
            renderMessages(activeChatId);

            // 상대방에게 전송
            const conn = connectedPeers[activeChatId].conn;
            if (conn && conn.open) {
                conn.send({ type: 'CHAT', content: text, time: timeStr });
            } else {
                alert('연결이 끊겨있어 전송할 수 없습니다.');
            }
            
            input.value = '';
        }

        function handleChatInput(e) { if (e.key === 'Enter') sendMessage(); }

        // --- 4. UI 렌더링 ---

        function renderFriendList() {
            const list = document.getElementById('friendListContent');
            list.innerHTML = '';
            
            const peers = Object.keys(connectedPeers);
            if (peers.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">연결된 친구가 없습니다.<br>ID로 친구를 추가해보세요!</p>';
                return;
            }

            peers.forEach(pid => {
                const p = connectedPeers[pid];
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <img src="${p.pic}">
                    <div class="item-info">
                        <h4>${p.name}</h4>
                        <p>${p.status || '온라인'}</p>
                    </div>
                `;
                div.onclick = () => openChat(pid);
                list.appendChild(div);
            });
        }

        function renderChatList() {
            const list = document.getElementById('chatListContent');
            list.innerHTML = '';
            
            const peers = Object.keys(connectedPeers);
            if (peers.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">대화 기록이 없습니다.</p>';
                return;
            }

            peers.forEach(pid => {
                const p = connectedPeers[pid];
                const lastMsg = p.messages[p.messages.length - 1];
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <img src="${p.pic}">
                    <div class="item-info">
                        <h4>${p.name}</h4>
                        <p>${lastMsg ? lastMsg.content : '대화 시작하기'}</p>
                    </div>
                `;
                div.onclick = () => openChat(pid);
                list.appendChild(div);
            });
        }

        function openChat(peerId) {
            activeChatId = peerId;
            const p = connectedPeers[peerId];
            document.getElementById('chatPartnerName').textContent = p.name;
            renderMessages(peerId);
            showScreen('chatDetailScreen');
        }

        function renderMessages(peerId) {
            const list = document.getElementById('chatMessages');
            list.innerHTML = '';
            const msgs = connectedPeers[peerId].messages;
            
            msgs.forEach(m => {
                const div = document.createElement('div');
                const isMe = m.sender === myId;
                div.className = `message-bubble ${isMe ? 'sent' : 'received'}`;
                div.innerHTML = `
                    <div class="message-content">${m.content}</div>
                    <div class="message-time">${m.time}</div>
                `;
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        }

        // --- 5. 프로필 변경 ---
        function openProfileModal() {
            document.getElementById('editName').value = myName;
            document.getElementById('editStatus').value = myStatus;
            document.getElementById('profileModal').style.display = 'flex';
        }
        function closeProfileModal() { document.getElementById('profileModal').style.display = 'none'; }
        function saveProfileChanges() {
            myName = document.getElementById('editName').value;
            myStatus = document.getElementById('editStatus').value;
            if (tempProfilePic) myPic = tempProfilePic;
            
            document.getElementById('myProfileName').textContent = myName;
            document.getElementById('myProfileStatus').textContent = myStatus;
            document.getElementById('myProfilePic').src = myPic;
            
            // 변경된 정보 연결된 친구들에게 전송
            Object.values(connectedPeers).forEach(peerData => {
                if(peerData.conn && peerData.conn.open) {
                    peerData.conn.send({ type: 'INFO', name: myName, pic: myPic, status: myStatus });
                }
            });
            
            // 로컬 스토리지에도 업데이트
            const users = getUsers();
            if(users[myId]) {
                users[myId].name = myName;
                users[myId].status = myStatus;
                users[myId].pic = myPic;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
            }

            closeProfileModal();
        }

        // 사진 선택 모달
        let tempProfilePic = null;
        function openFileModal() { document.getElementById('fileModal').style.display = 'flex'; }
        function closeFileModal() { document.getElementById('fileModal').style.display = 'none'; }
        function confirmProfilePicture() {
            const val = document.getElementById('selectedFileUrl').value;
            if (val) { 
                // URL이 아니면 ui-avatars 색상으로 간주
                tempProfilePic = val.startsWith('http') ? val : `https://ui-avatars.com/api/?name=${myName}&background=${val.replace('#','')}&color=fff`;
                closeFileModal(); 
            }
        }
        function selectProfilePicture() {
            tempProfilePic = `https://ui-avatars.com/api/?name=${myName}&background=random&color=fff`;
            closeFileModal();
        }

        function showScreen(id, btn) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
            if (btn) {
                document.querySelectorAll('.footer-nav button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            if(id === 'friendsScreen') renderFriendList();
            if(id === 'chatListScreen') renderChatList();
        }

        // 자동 로그인 체크
        window.addEventListener('load', () => {
            const savedId = localStorage.getItem(LOGIN_KEY);
            if (savedId) {
                // 자동 로그인 시도
                startApp(savedId);
            } else {
                showScreen('loginScreen');
            }
        });

    </script>
</body>
</html>